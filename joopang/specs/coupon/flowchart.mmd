flowchart TD
    A[쿠폰 발급 요청 수신] --> B[요청 파라미터 및 사용자 검증]
    B --> C[선착순 토큰 획득]
    C --> D{토큰 확보 성공?}
    D -->|No| E[재고 소진 응답 반환]
    D -->|Yes| F[사용자 중복 발급 조회]
    F --> G{기존 발급 존재?}
    G -->|Yes| H[토큰 롤백 및 중복 안내]
    H --> M[사용자에게 응답]
    G -->|No| I[쿠폰 발급 레코드 생성\ncoupons]
    I --> J[발급 상태 커밋]
    J --> K[토큰 확정]
    K --> L[성공 응답 반환]
