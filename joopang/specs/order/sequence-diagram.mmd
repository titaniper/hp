sequenceDiagram
    participant U as 사용자
    participant FE as 웹/앱 클라이언트
    participant OS as 주문 서비스
    participant IS as 재고 서비스
    participant DS as 할인 서비스
    participant DB as 주문 DB
    participant PG as 결제 게이트웨이
    participant DV as 배송 서비스
    participant DP as 데이터 플랫폼

    U->>FE: 장바구니 주문 제출
    activate FE
    FE->>OS: 주문 생성 요청 (payload)
    activate OS
    OS->>OS: 기본 유효성 검증
    OS->>IS: 재고 차감 또는 예약 요청
    alt 재고 부족 또는 실패
        activate IS
        IS-->>OS: 실패 응답
        deactivate IS
        OS-->>FE: 주문 실패 (재고 부족)
        FE-->>U: 실패 안내
    else 재고 확보 완료
        activate IS
        IS-->>OS: 성공 응답 (예약 ID)
        deactivate IS
        activate DS
        OS->>DS: 할인 계산 요청 (쿠폰/포인트)
        alt 쿠폰 만료 또는 사용 불가
            DS-->>OS: 실패 응답 (쿠폰 오류)
            OS->>IS: 재고 예약 해제
            activate IS
            IS-->>OS: 예약 해제 완료
            deactivate IS
            OS-->>FE: 주문 실패 (쿠폰 오류)
            FE-->>U: 실패 안내
        else 할인 적용 가능
            DS-->>OS: 할인 결과
            deactivate DS
            rect rgba(215, 235, 255, 0.25)
                Note over OS,DB: 트랜잭션 시작
                OS->>DB: orders, order_items 저장 (status=PENDING)
                activate DB
                DB-->>OS: 저장 완료
                deactivate DB
            end
            OS->>PG: 결제 승인 요청 (final amount)
            activate PG
            alt 결제 실패
                PG-->>OS: 실패 응답
                Note over OS,DB: 트랜잭션 롤백
                OS->>IS: 재고 예약 해제
                activate IS
                IS-->>OS: 예약 해제 완료
                deactivate IS
                OS->>DB: 주문 상태 CANCELLED 업데이트
                activate DB
                DB-->>OS: 업데이트 완료
                deactivate DB
                OS-->>FE: 결제 실패 응답
                FE-->>U: 실패 안내
            else 결제 성공
                PG-->>OS: 성공 응답 (승인키)
                deactivate PG
                rect rgba(215, 235, 255, 0.25)
                    Note over OS,DB: 트랜잭션 커밋 준비
                    OS->>DB: payments 적재 및 주문 상태 PAID 업데이트
                    activate DB
                    DB-->>OS: 업데이트 완료
                    deactivate DB
                    Note over OS,DB: 트랜잭션 커밋
                end
                OS->>DV: 배송 지시 생성 요청
                activate DV
                DV-->>OS: 배송 정보 생성 결과
                deactivate DV
                OS->>DP: 주문/결제 이벤트 전송
                activate DP
                DP-->>OS: 수신 확인
                deactivate DP
                OS-->>FE: 주문 완료 응답
                FE-->>U: 주문 완료 화면 표시
            end
        end
    end
    deactivate FE
    deactivate OS
