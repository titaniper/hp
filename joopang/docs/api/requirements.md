# API 요구사항 — 주팡(Coupang Inspired)

## 1. 개요
- **목표**: 한국과 미국 시장을 지원하는 쿠팡형 이커머스 플랫폼 ‘주팡’의 상품·주문·결제·쿠폰·재고·외부 연동 API 요구사항 정의.
- **범위**: 고객용 퍼블릭 API와 내부 서비스 API 모두 포함.
- **가정**:
  - 사용자는 비회원으로 탐색 가능하나 주문/쿠폰 발급 시 인증 필요.
  - 결제는 주팡 지갑(잔액) 혹은 사전에 승인된 결제수단을 사용하며, 외부 PG 연동은 1차 범위에 포함하지 않음.
  - 외부 데이터 플랫폼 연동은 비동기로 처리하며 주문 완료를 차단하지 않음.

## 2. 기능 요구사항

### 2.1 카탈로그·상품 탐색
- 카테고리 필터, 가격/인기/최신 정렬을 지원하는 상품 목록·상세·검색 API 제공.
- 시장별 현지화된 상품 메타데이터(이름, 설명, 통화)를 반환하며, 기본 로캘은 사용자 프로필 또는 Accept-Language 기반.
- 실시간 재고/가격과 프로모션 정보(쿠폰 적용 가능 여부, 세일가)를 함께 제공.
- 최근 3일 기준 시장별 Top 5 인기 상품 조회 API 제공.

### 2.2 재고 관리
- SKU별 실시간 재고 수량 유지, 동시 주문 환경에서도 원자적으로 반영.
- 체크아웃 시 재고 예약, 결제 실패 또는 타임아웃 시 자동 해제.
- 내부 재고 조정 API 제공(입고, 보정) 및 감사 로그(담당자, 시점, 사유) 기록.
- 재고 변경 이벤트를 다운스트림 분석 시스템으로 발행.

### 2.3 장바구니
- 회원 장바구니는 지속 저장, 비회원은 세션 기반 장바구니 지원.
- 상품 추가/수정/삭제 시 수량 검증, 구매 한도/재고 초과 불가.
- 장바구니 합계(소계, 예상 세금, 배송비) 및 쿠폰 사전 검증 제공.

### 2.4 주문·체크아웃
- 클라이언트 제공 멱등 키를 기반으로 주문 생성 API 멱등성 보장.
- 재고/잔액 검증 후 주문 확정, 실패 시 명확한 오류 코드 제공.
- 재고 차감은 결제 승인이 완료된 후 수행하며, 하위 시스템 지연 시에도 최종 일관성 보장.
- 주문 상태 전이(`PENDING`, `PAID`, `FULFILLED`, `CANCELLED`, `REFUNDED`)를 위한 내부 API 제공.
- 주문 상세 조회, 주문 이력 리스트, 상태별 취소 가능(배송 진행 전 제한).

### 2.5 결제·잔액
- 주팡 지갑 잔액 결제를 지원하고, 쿠폰 할인 후 최종 결제 금액 계산.
- 잔액 부족 검증 및 멱등 결제 토큰으로 중복 청구 방지.
- 잔액 조회, 거래 내역, 환불 처리 API 제공.

### 2.6 쿠폰 시스템
- 한정 수량 선착순 쿠폰 발급과 사용자별 사용 제한 지원.
- 유효 기간, 사용 횟수, 상품/카테고리, 국가 제한 등 쿠폰 적격성 검증.
- 체크아웃 시 쿠폰 적용 가능, 할인 적용 후 잔액 차감.
- 쿠폰 사용 이력 추적 및 관리자용 발급 정책 관리, 잔량 모니터링, 회수 기능 제공.

### 2.7 외부 데이터 연동
- 주문/쿠폰 이벤트를 아웃박스 패턴으로 저장 후 외부 데이터 플랫폼에 비동기 전송.
- 전송 실패가 주문 완료를 차단하지 않으며, 실패 상태 기록 및 재전송.
- 데이터 전송 성공/실패/지연에 대한 모니터링 지표 및 엔드포인트 제공.

### 2.8 현지화·시장 지원
- KRW, USD 등 다중 통화 가격 지원, 환율 및 반올림 규칙 정확히 적용.
- 한글/영문 에러 메시지 및 알림 제공.
- 시장별 규제(예: 전자 영수증, 반품 정책)를 설정 기반으로 지원.

### 2.9 가시성·리포팅
- 주요 흐름(재고 예약, 결제, 쿠폰 발급)에 대한 구조화 로그 수집.
- 재고 예약 지연, 주문 완료율, 쿠폰 발급 성공률 등 지표 제공 및 알림 설정.
- 시장별 일별 매출, 쿠폰 사용률 등 분석용 집계를 스케줄링 또는 데이터 익스포트로 제공.

## 3. 비기능 요구사항
- **가용성**: 핵심 API(`/products`, `/orders`, `/payments`, `/coupons`) 99.9% 이상.
- **성능**: 일반 부하 기준 읽기 API P95 200ms 이하, 쓰기 API P95 400ms 이하, 재고 검증 100ms 이하.
- **확장성**: 카탈로그/주문 서비스 수평 확장 지원, 쿠폰 발급은 플래시 세일과 같은 급격한 트래픽도 과발급 없이 처리.
- **일관성**: 재고 예약·쿠폰 수량은 강한 일관성, 분석 데이터는 최종적 일관성 허용.
- **신뢰성**: 하위 의존성 재시도, 회로 차단기 적용, 아웃박스 이벤트는 최소 1회 전달 및 중복 제거.
- **보안/준수**: 인증(OAuth2/JWT), 관리자/내부 API RBAC, 전송 구간 TLS, 저장 데이터 암호화, 개인정보 국외 이전 및 PCI 관련 요건 준수.
- **현지화**: 사용자/세션별 로캘 유지, 기본 언어/통화 폴백 제공, 날짜/숫자 포맷 로캘별 처리.
- **유지보수성**: 버전 관리된 API와 폐기 정책 제공, OpenAPI 문서와 핵심 흐름에 대한 자동화 테스트 유지.
- **관측성**: 중앙 집중 로그, 분산 추적, 재고 이상·쿠폰 소진·외부 전송 적체에 대한 경보 기준 정의.

## 4. 사용자 역할 및 권한
- **비회원**
  - 상품 탐색, 현지화된 가격/재고 조회, 세션 장바구니 생성.
  - 주문/쿠폰 발급 불가.
- **회원 고객**
  - 비회원 기능 포함, 장바구니 영속 관리, 쿠폰 발급/적용, 주문 생성, 지갑 잔액 관리, 주문 이력 조회, 취소/환불 요청.
- **고객 상담사**
  - 고객 프로필, 주문, 쿠폰 사용 현황 조회, 정책 범위 내 환불/수동 조정 가능. 재고 변경은 불가.
- **재고 관리자**
  - 재고 수량 조정, 감사 로그 조회, 입고 트리거. 고객 금융 데이터 접근 권한 없음.
- **마케팅 관리자**
  - 쿠폰 캠페인 구성, 발급/사용 현황 모니터링, 쿠폰 회수, 프로모션 플래그 관리.
- **운영 관리자**
  - 운영 대시보드 전체 접근, 주문 강제 처리, 시스템 설정 변경, 사용자 역할 관리, 연동 상태 확인.
- **외부 데이터 플랫폼(시스템 역할)**
  - 안전한 채널을 통한 이벤트 수신, 재전송 요청 가능, 트랜잭션 API 접근 권한 없음(아웃박스 전달 엔드포인트만 사용).

## 5. 오픈 이슈
- 결제 범위 확대: MVP에서 주팡 지갑만 사용할지, 외부 PG 연동이 필요한지?
- 세금/배송비 계산: API에서 직접 계산할지, 별도 서비스에 위임할지?
- 재고 소싱: 초기 릴리스에서 다중 물류창고(지역별 재고 풀)를 지원할지?
