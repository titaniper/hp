# 기능 명세(Function Specification)

> **참고**: 비즈니스 요구사항은 [docs/design/brd.md](brd.md), 제품 요구사항은 [docs/design/prd.md](prd.md)에 정리돼 있습니다. 본 문서는 기능 단위의 상세 동작을 정의하고, API/도메인 설계는 [docs/design/api-specification.md](api-specification.md)에서 다룹니다.

## 1. 카탈로그 / 상품

### FS-PROD-01 상품 목록 조회
- **설명**: 카테고리, 가격, 인기, 최신 정렬을 지원하는 상품 목록을 조회한다.
- **입력**
  - `categoryId`(선택): UUID, 상위/하위 카테고리 필터
  - `sort`: `PRICE_ASC`, `PRICE_DESC`, `POPULAR`, `NEWEST`
  - `locale`: 언어+통화 지정 (헤더 기반)
- **처리**
  - `ProductService.getProducts` 호출
  - 로캘 기반 가격/통화 변환, 프로모션 정보 계산
  - 최신 재고 수량(1분 캐시 허용) 포함
- **출력**
  - 상품 리스트(상품 기본 정보, 가격, 재고, 할인, 이미지)
- **오류 코드**
  - `INVALID_LOCALE`, `CATEGORY_NOT_FOUND`
- **관련 문서**: [api-specification.md#GET-/api/products](api-specification.md)

### FS-PROD-02 인기 상품 조회
- **설명**: 최근 3일간 시장별 판매량 기준 Top5 상품을 반환한다.
- **입력**: `days`(기본 3), `limit`(기본 5), `locale`
- **처리**: `ProductService.getTopProducts` → `ProductMetricsDaily` 데이터 집계
- **출력**: 랭크, 상품 요약 정보
- **오류 코드**: `INVALID_LIMIT`

### FS-PROD-03 상품 상세 조회
- **설명**: 상품 기본 정보 + 옵션 목록 + 재고 합계를 반환한다.
- **입력**: `productId`
- **처리**: `ProductService.getProduct`
- **출력**: 상품 상세, 옵션 단위 재고/가격, 총 재고
- **오류 코드**: `PRODUCT_NOT_FOUND`

### FS-PROD-04 재고 검증
- **설명**: 특정 옵션 수량을 주문 가능한지 검증한다.
- **입력**: `productId`, `quantity`
- **처리**
  - `ProductService.checkStock`
  - 실시간 `StockQuantity` 비교
- **출력**: `available`, `currentStock`, `requested`
- **오류 코드**: `PRODUCT_NOT_FOUND`, `INSUFFICIENT_STOCK`

## 2. 장바구니

### FS-CART-01 장바구니 생성/조회
- **설명**: 회원은 영속 저장, 비회원은 세션 기반 장바구니를 관리한다.
- **입력**: `userId`(선택), `sessionId`
- **처리**: `CartService`가 없으므로 향후 구현. 저장소는 추후 Redis/DB 결정.
- **출력**: 장바구니 항목 리스트(상품ID, 옵션, 수량, 단가)

### FS-CART-02 장바구니 항목 업데이트
- **설명**: 상품 추가/수정/삭제, 수량 검증을 수행한다.
- **입력**: `productId`, `optionId`, `quantity`, `userId/sessionId`
- **처리**
  - 재고/한도 검증 (`ProductService.checkStock`)
  - 장바구니 상태 업데이트
- **오류 코드**: `INSUFFICIENT_STOCK`, `MAX_QUANTITY_EXCEEDED`

### FS-CART-03 예상 결제 금액 계산
- **설명**: 장바구니 기반 소계, 예상 세금, 배송비, 쿠폰 사전 검증을 수행한다.
- **입력**: 장바구니 ID, 쿠폰 후보
- **처리**
  - 쿠폰 적격성 체크(`CouponService`)
  - 세금/배송비 규칙을 적용(간이 룰)
- **출력**: `subtotal`, `discount`, `tax`, `shipping`, `total`

## 3. 주문 & 결제

### FS-ORDER-01 주문 생성
- **설명**: 멱등 키 기반으로 주문을 생성한다.
- **입력**
  - `idempotencyKey`, `userId`, `items`(상품ID, 옵션ID, 수량), `couponId`, 배송 정보
- **처리**
  - 멱등 키 검증
  - `OrderService.createOrder` 호출
    - 사용자 검증 (`UserRepository`)
    - 재고 예약 (`ProductLockManager` + `ProductRepository`)
    - 쿠폰 검증/할인 (`CouponRepository`)
    - 주문/아이템 엔티티 생성 및 저장 (`OrderRepository`)
- **출력**: 주문 식별자, 결제 상태(`PENDING`), 할인 금액
- **오류 코드**
  - `ORDER_DUPLICATED`, `USER_NOT_FOUND`, `INSUFFICIENT_STOCK`,
    `COUPON_SOLD_OUT`, `INVALID_COUPON`

### FS-ORDER-02 주문 조회
- **설명**: 주문 상세 및 목록을 조회한다.
- **입력**: `orderId` 혹은 `userId`
- **처리**: `OrderService.getOrder`, `OrderService.listOrders`
- **출력**: 주문 본문 + 아이템 + 할인 + 결제 상태
- **오류 코드**: `ORDER_NOT_FOUND`

### FS-ORDER-03 결제 처리
- **설명**: 지갑 잔액을 사용해 주문을 결제한다.
- **입력**: `orderId`, `userId`
- **처리**
  - 주문 소유자 검증
  - 지갑 잔액 차감(`UserRepository` → `Money`)
  - 쿠폰 사용 완료 처리
  - 주문 상태 `PAID`로 업데이트 + 결제 시각
  - 아웃박스 전송 페이로드 생성 (`OrderDataTransmissionService`)
- **출력**: 결제 결과(지불 금액, 잔액, 시각)
- **오류 코드**: `ORDER_NOT_FOUND`, `USER_NOT_FOUND`, `INSUFFICIENT_BALANCE`

### FS-ORDER-04 주문 상태 전이
- **설명**: `PAID → FULFILLED`, `PAID → CANCELLED`, `PAID → REFUNDED` 등의 전이를 관리한다.
- **입력**: 상태 변경 요청 (`orderId`, `targetStatus`, `reason`)
- **처리**
  - 상태 머신 검증 (불가 전이 차단)
  - 환불/취소 시 재고/쿠폰 복구 로직 필요
- **오류 코드**: `INVALID_STATUS_TRANSITION`

## 4. 결제 / 지갑

### FS-PAY-01 잔액 조회 및 입출금
- **설명**: 사용자 지갑 잔액과 거래 내역을 제공한다.
- **입력**: `userId`
- **처리**: `UserRepository`를 통해 도메인 모델 조회
- **출력**: 현재 잔액, 입금/차감 히스토리
- **오류 코드**: `USER_NOT_FOUND`

### FS-PAY-02 환불 처리
- **설명**: 주문 취소/환불 시 잔액을 복구한다.
- **입력**: `orderId`, `userId`, `amount`
- **처리**: 주문 상태 검증 후 잔액 증가, 환불 트랜잭션 기록
- **오류 코드**: `ORDER_NOT_REFUNDABLE`

## 5. 쿠폰

### FS-COUPON-01 쿠폰 발급
- **설명**: 한정 수량 선착순 쿠폰을 발급한다.
- **입력**: `couponTemplateId`, `userId`
- **처리**
  - `CouponLockManager.withTemplateLock`으로 템플릿 단위 락 처리
  - 템플릿 검증 (`CouponTemplateRepository`)
  - 사용자 기 발급 내역 확인 (`CouponRepository`)
  - 쿠폰 생성 및 저장, 잔량 감소
- **출력**: 발급된 사용자 쿠폰 정보
- **오류 코드**: `COUPON_SOLD_OUT`, `ALREADY_USED`, `INVALID_COUPON`

### FS-COUPON-02 사용자 쿠폰 조회
- **설명**: 사용자가 보유한 쿠폰 목록을 반환한다.
- **입력**: `userId`
- **처리**: `CouponRepository.findUserCoupons`
- **출력**: 쿠폰 리스트(상태, 만료일, 사용 이력)

### FS-COUPON-03 쿠폰 적용
- **설명**: 주문 결제 과정에서 쿠폰을 적용한다.
- **입력**: `orderId`, `couponId`
- **처리**
  - 쿠폰 상태 검증(기간/호환성)
  - 할인 금액 계산(`Coupon.apply`)
  - 주문 할인 항목(`OrderDiscount`) 생성
- **오류 코드**: `INVALID_COUPON`, `EXPIRED_COUPON`, `ALREADY_USED`

### FS-COUPON-04 쿠폰 회수/관리
- **설명**: 관리자용 쿠폰 회수, 발급 정책 변경, 잔량 모니터링.
- **상태**: 추후 구현 예정 (관리자 API 정의 필요)

## 6. 외부 데이터 연동

### FS-DATA-01 아웃박스 기록
- **설명**: 주문/쿠폰 이벤트를 아웃박스 테이블에 저장한다.
- **입력**: 이벤트 타입, 페이로드
- **처리**: `OrderDataTransmissionService` 또는 유사 서비스에서 스냅샷 생성
- **출력**: 아웃박스 레코드 ID

### FS-DATA-02 전송 및 재시도
- **설명**: 외부 데이터 플랫폼으로 비동기 전송, 실패 시 재시도.
- **상태**: 서비스/인프라 어댑터 구현 필요 (`infrastructure` 계층)

## 7. 현지화 / 시장 지원

### FS-LOC-01 로캘 처리
- **설명**: 요청 헤더의 언어/통화 정보를 파싱하고 기본 값을 제공한다.
- **처리**: 인터셉터/필터에서 로캘 컨텍스트 세팅

### FS-LOC-02 가격/세금 계산
- **설명**: 통화 변환, 반올림 규칙, 세금 계산 로직 적용.
- **상태**: MVP에서는 고정 규칙 적용, 추후 외부 서비스 연동 고려

### FS-LOC-03 규제 정책
- **설명**: 시장별 환불 기한, 전자 영수증 등 정책을 설정 파일로 관리.

## 8. 운영 / 관측성

### FS-OPS-01 감사 로그
- **설명**: 재고 조정, 쿠폰 회수, 주문 취소 등 주요 액션에 대한 감사 로그 기록.
- **처리**: 공통 인프라 로깅 모듈 준비 필요

### FS-OPS-02 모니터링 지표
- **설명**: 재고 예약 지연, 주문 완료율, 쿠폰 발급 성공률 등 메트릭 수집.
- **처리**: Micrometer/Prometheus 연동 (의존성 준비되어 있음)

### FS-OPS-03 경보/알림
- **설명**: 일정 임계치 초과 시 알림 발송 (Slack/Webhook 등).
- **상태**: 알림 채널 및 정책 정의 필요

## 9. 미구현 / 후속 과제
- 장바구니 서비스 및 영속화
- 결제 외부 PG 연동
- 외부 데이터 플랫폼 전송 인프라 구현
- 관리자 API (쿠폰 회수, 재고 관리 등)
- 다국어 메시지/번역 파일 체계화

## 10. 추적 매핑
| 기능 ID | BRD 참조 | PRD 기능 | 관련 도메인 |
| --- | --- | --- | --- |
| FS-PROD-01~04 | BRD 2.1, 2.2 | PRD 5.1 | product |
| FS-CART-01~03 | BRD 2.3 | PRD 5.3 | cart, product |
| FS-ORDER-01~04 | BRD 2.4 | PRD 5.4 | order, product, coupon, payment |
| FS-PAY-01~02 | BRD 2.5 | PRD 5.4 | payment, user |
| FS-COUPON-01~04 | BRD 2.6 | PRD 5.5 | coupon |
| FS-DATA-01~02 | BRD 2.7 | PRD 5.6 | order, coupon |
| FS-LOC-01~03 | BRD 2.8 | PRD 5.7 | common |
| FS-OPS-01~03 | BRD 2.9 | PRD 5.8 | common, infrastructure |
