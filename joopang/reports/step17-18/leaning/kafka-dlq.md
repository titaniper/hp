# 카프카 DLQ(Dead Letter Queue)

## 개요
- DLQ는 처리 실패 메시지를 격리해 정상 스트림을 보호하는 보조 토픽이다.
- 컨슈머가 재시도 끝에 실패하거나 스키마 불일치·비즈니스 검증 오류가 발생했을 때 메시지를 별도 토픽으로 전송한다.
- DLQ 토픽은 일반 토픽과 동일한 파티션 구조를 가지지만, 보존 기간을 더 길게 두거나 compaction을 꺼서 전체 기록을 남기는 편이다.

## 사용 시나리오
1. **스키마 진화 실패**: Avro/JSON 스키마 호환성 문제로 역직렬화가 되지 않을 때 오류 payload와 헤더를 DLQ에 저장한다.
2. **비즈니스 규칙 위반**: 정상 데이터 흐름을 막지 않으면서 문제 데이터를 사후 조사할 수 있다.
3. **다운스트림 장애**: 외부 시스템 장애로 영구 실패가 발생할 경우, DLQ에 보관한 뒤 장애 해결 후 재처리한다.

## 설계 체크리스트
- **전송 책임**: 프로듀서 재시도 실패 시 전송할지, 컨슈머가 실패 메시지를 재발행할지 결정한다.
- **메시지 포맷**: 원본 payload + 메타데이터(오프셋, 파티션, 예외 스택, 처리 시각)를 함께 저장해 디버깅을 쉽게 한다.
- **재처리 파이프라인**: DLQ 토픽을 읽어 수동/자동으로 복구하는 별도 배치 또는 스트림 잡을 마련한다.
- **알림**: DLQ 토픽 메시지 증가 추이, 특정 에러 코드 발생률 등을 모니터링해 즉시 알린다.
