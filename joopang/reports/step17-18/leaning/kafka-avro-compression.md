# Avro와 압축 전략

---

## Avro란?

Apache Avro는 데이터 직렬화 시스템으로, 스키마 기반의 효율적인 바이너리 인코딩을 제공한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│                     직렬화 포맷 비교                                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [JSON]                                                               │
│  ┌─────────────────────────────────────────────────────────┐         │
│  │ {                                                       │         │
│  │   "userId": 12345,                                      │         │
│  │   "name": "홍길동",                                      │         │
│  │   "email": "hong@example.com"                           │         │
│  │ }                                                       │         │
│  │                                                         │         │
│  │ 크기: ~80 bytes (필드명 포함, 텍스트)                     │         │
│  └─────────────────────────────────────────────────────────┘         │
│                                                                       │
│  [Avro Binary]                                                        │
│  ┌─────────────────────────────────────────────────────────┐         │
│  │ [magic byte][schema id][12345][홍길동][hong@example.com] │         │
│  │                                                         │         │
│  │ 크기: ~30 bytes (필드명 없음, 바이너리)                   │         │
│  └─────────────────────────────────────────────────────────┘         │
│                                                                       │
│  💡 Avro는 JSON 대비 60~80% 크기 감소                                 │
└──────────────────────────────────────────────────────────────────────┘
```

### Avro vs 다른 포맷 비교

| 포맷 | 스키마 | 크기 | 속도 | 언어 지원 | 스키마 진화 |
|------|--------|------|------|-----------|-------------|
| **JSON** | 없음 | 큼 | 느림 | 전체 | 유연하지만 검증 어려움 |
| **Avro** | 필수 | 작음 | 빠름 | 대부분 | 우수 (호환성 검증) |
| **Protobuf** | 필수 | 작음 | 매우 빠름 | 대부분 | 우수 |
| **Thrift** | 필수 | 작음 | 빠름 | 대부분 | 양호 |

---

## Avro 스키마 관리

Avro는 스키마와 데이터를 분리해 직렬화하며, Schema Registry에 버전으로 저장해 프로듀서·컨슈머 간 호환성을 유지한다.

### Schema Registry 아키텍처

```
┌──────────────────────────────────────────────────────────────────────┐
│                   Schema Registry 동작 흐름                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│   [Producer]                                                          │
│       │                                                               │
│       │ ① 스키마 등록 요청                                             │
│       ▼                                                               │
│   ┌─────────────────────┐                                             │
│   │   Schema Registry   │                                             │
│   │  ┌───────────────┐  │                                             │
│   │  │ Subject:      │  │                                             │
│   │  │ orders-value  │  │                                             │
│   │  │ ┌───────────┐ │  │                                             │
│   │  │ │ v1: {...} │ │  │                                             │
│   │  │ │ v2: {...} │ │  │                                             │
│   │  │ │ v3: {...} │ │  │  ← 버전별 스키마 저장                        │
│   │  │ └───────────┘ │  │                                             │
│   │  └───────────────┘  │                                             │
│   └──────────┬──────────┘                                             │
│              │ ② schema_id 반환 (예: 42)                              │
│              ▼                                                        │
│   [Producer]                                                          │
│       │                                                               │
│       │ ③ 메시지 전송: [magic(1)][schema_id(4)][data(N)]              │
│       ▼                                                               │
│   ┌─────────────────────┐                                             │
│   │   Kafka Broker      │                                             │
│   └──────────┬──────────┘                                             │
│              │                                                        │
│              ▼                                                        │
│   [Consumer]                                                          │
│       │                                                               │
│       │ ④ schema_id로 스키마 조회                                      │
│       ▼                                                               │
│   ┌─────────────────────┐                                             │
│   │   Schema Registry   │  ← 스키마 캐시 (로컬)                        │
│   └─────────────────────┘                                             │
│              │                                                        │
│              │ ⑤ 스키마로 역직렬화                                     │
│              ▼                                                        │
│   [Consumer] 데이터 처리                                               │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### Avro 메시지 구조

```
┌──────────────────────────────────────────────────────────────────────┐
│                   Avro 메시지 바이너리 구조                            │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────┬──────────────┬────────────────────────────────────┐      │
│  │ Magic  │  Schema ID   │            Avro Data               │      │
│  │ Byte   │  (4 bytes)   │         (Variable length)          │      │
│  │  0x0   │              │                                    │      │
│  └────────┴──────────────┴────────────────────────────────────┘      │
│  │← 1B →│ │←── 4B ────→│ │←────── N bytes ──────────────────→│      │
│                                                                       │
│  예시: 주문 메시지                                                     │
│  ┌────┬─────────┬──────────────────────────────────────────────┐     │
│  │0x0 │ 0x00002A │ [orderId][userId][amount][timestamp][items] │     │
│  │    │ (id=42)  │                                             │     │
│  └────┴─────────┴──────────────────────────────────────────────┘     │
│                                                                       │
│  💡 스키마 ID만 전송하므로 매 메시지마다 스키마를 보내지 않아 효율적       │
└──────────────────────────────────────────────────────────────────────┘
```

### 호환성 모드

`BACKWARD`(기본)로 설정해 새로운 스키마가 이전 컨슈머와 호환되도록 한다. 필요에 따라 `FULL`, `FORWARD` 모드를 선택한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│                     스키마 호환성 모드                                 │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [BACKWARD] (기본값, 권장)                                            │
│  ────────────────────────────────────────                             │
│  새 스키마로 이전 데이터를 읽을 수 있음                                 │
│                                                                       │
│    v1 (Writer)     v2 (Reader)                                        │
│    ┌─────────┐     ┌─────────────┐                                    │
│    │ name    │ ──► │ name        │  ✅ 읽기 가능                       │
│    │ email   │     │ email       │                                    │
│    └─────────┘     │ phone (new) │  ← 기본값 사용                      │
│                    └─────────────┘                                    │
│                                                                       │
│  사용 사례: 컨슈머 먼저 배포, 프로듀서 나중 배포                         │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [FORWARD]                                                            │
│  ────────────────────────────────────────                             │
│  이전 스키마로 새 데이터를 읽을 수 있음                                 │
│                                                                       │
│    v2 (Writer)     v1 (Reader)                                        │
│    ┌─────────────┐ ┌─────────┐                                        │
│    │ name        │ │ name    │  ✅ 읽기 가능                           │
│    │ email       │ │ email   │                                        │
│    │ phone (new) │ └─────────┘  ← phone 무시됨                        │
│    └─────────────┘                                                    │
│                                                                       │
│  사용 사례: 프로듀서 먼저 배포, 컨슈머 나중 배포                         │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [FULL] (가장 안전)                                                    │
│  ────────────────────────────────────────                             │
│  BACKWARD + FORWARD 모두 만족                                         │
│                                                                       │
│    v1 ◄──────────────► v2                                             │
│       양방향 호환 가능                                                  │
│                                                                       │
│  사용 사례: 배포 순서에 관계없이 안전하게 운영                           │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [NONE]                                                               │
│  ────────────────────────────────────────                             │
│  호환성 검사 비활성화 (⚠️ 프로덕션 비권장)                              │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 스키마 진화 규칙

필드 추가 시 기본값을 지정, 필드 삭제 시 optional 처리, 타입 변경 시 union 사용 등 점진적 변화를 준수한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│                     스키마 진화 Best Practices                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ✅ 허용되는 변경 (호환성 유지)                                         │
│  ═══════════════════════════════                                      │
│                                                                       │
│  1. 기본값이 있는 필드 추가                                            │
│     ┌─────────────────────────────────────────────────────────────┐  │
│     │ // Before (v1)                                              │  │
│     │ {                                                           │  │
│     │   "type": "record",                                         │  │
│     │   "name": "User",                                           │  │
│     │   "fields": [                                               │  │
│     │     {"name": "id", "type": "long"},                         │  │
│     │     {"name": "name", "type": "string"}                      │  │
│     │   ]                                                         │  │
│     │ }                                                           │  │
│     │                                                             │  │
│     │ // After (v2) - 기본값과 함께 필드 추가                       │  │
│     │ {                                                           │  │
│     │   "type": "record",                                         │  │
│     │   "name": "User",                                           │  │
│     │   "fields": [                                               │  │
│     │     {"name": "id", "type": "long"},                         │  │
│     │     {"name": "name", "type": "string"},                     │  │
│     │     {"name": "email", "type": "string", "default": ""}  ✅  │  │
│     │   ]                                                         │  │
│     │ }                                                           │  │
│     └─────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  2. Optional 필드 삭제 (기본값이 있었던 필드)                           │
│     ┌─────────────────────────────────────────────────────────────┐  │
│     │ // v2에서 v3로: email 필드 제거 (기본값이 있었으므로 OK)        │  │
│     │ {                                                           │  │
│     │   "fields": [                                               │  │
│     │     {"name": "id", "type": "long"},                         │  │
│     │     {"name": "name", "type": "string"}                      │  │
│     │   ]                                                         │  │
│     │ }                                                           │  │
│     └─────────────────────────────────────────────────────────────┘  │
│                                                                       │
│  3. Union으로 타입 확장                                                │
│     ┌─────────────────────────────────────────────────────────────┐  │
│     │ // Before: string만 허용                                     │  │
│     │ {"name": "status", "type": "string"}                        │  │
│     │                                                             │  │
│     │ // After: null도 허용 (union 사용)                           │  │
│     │ {"name": "status", "type": ["null", "string"], "default": null}│
│     └─────────────────────────────────────────────────────────────┘  │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ❌ 금지되는 변경 (호환성 깨짐)                                         │
│  ═══════════════════════════════                                      │
│                                                                       │
│  1. 기본값 없이 필드 추가                                              │
│     {"name": "phone", "type": "string"}  ❌ 기본값 필수!              │
│                                                                       │
│  2. 필수 필드 삭제                                                     │
│     기본값이 없던 필드를 삭제하면 이전 데이터 읽기 실패                  │
│                                                                       │
│  3. 필드 이름 변경                                                     │
│     "userName" → "name"  ❌ 새 필드로 인식됨                          │
│                                                                       │
│  4. 호환되지 않는 타입 변경                                            │
│     "string" → "int"  ❌                                              │
│     "int" → "long"    ✅ (승격 허용)                                  │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 운영 팁

토픽별 subject naming 전략(`<topic>-value`)을 통일하고, CI 단계에서 스키마 검증을 수행한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│                   Subject Naming 전략                                 │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [TopicNameStrategy] (기본값)                                         │
│  ─────────────────────────────                                        │
│  Subject = <topic>-key 또는 <topic>-value                             │
│                                                                       │
│  예시:                                                                 │
│  ┌────────────────┬─────────────────────┐                             │
│  │ Topic          │ Subject             │                             │
│  ├────────────────┼─────────────────────┤                             │
│  │ orders         │ orders-key          │                             │
│  │                │ orders-value        │                             │
│  │ user-events    │ user-events-key     │                             │
│  │                │ user-events-value   │                             │
│  └────────────────┴─────────────────────┘                             │
│                                                                       │
│  장점: 간단, 토픽별 스키마 관리                                         │
│  단점: 같은 스키마를 여러 토픽에서 사용 시 중복                          │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [RecordNameStrategy]                                                 │
│  ─────────────────────                                                │
│  Subject = Avro record의 full name                                    │
│                                                                       │
│  예시:                                                                 │
│  ┌────────────────────────────────────────────┐                       │
│  │ Subject = com.example.orders.OrderCreated  │                       │
│  └────────────────────────────────────────────┘                       │
│                                                                       │
│  장점: 스키마 재사용, 도메인 모델과 일치                                 │
│  단점: 설정 복잡                                                       │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

#### CI/CD 스키마 검증 파이프라인

```
┌──────────────────────────────────────────────────────────────────────┐
│                   CI 스키마 검증 흐름                                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [Developer]                                                          │
│       │                                                               │
│       │ ① 스키마 파일 수정 (*.avsc)                                    │
│       ▼                                                               │
│  ┌─────────────┐                                                      │
│  │   Git Push  │                                                      │
│  └──────┬──────┘                                                      │
│         │                                                             │
│         ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │                    CI Pipeline                               │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │ Step 1: Schema Syntax Validation                    │    │     │
│  │  │   $ avro-tools compile schema User.avsc .           │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  │                         │                                   │     │
│  │                         ▼                                   │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │ Step 2: Compatibility Check                         │    │     │
│  │  │   $ curl -X POST                                    │    │     │
│  │  │     http://schema-registry:8081/                    │    │     │
│  │  │     compatibility/subjects/orders-value/versions/latest│  │     │
│  │  │     -d @new-schema.json                             │    │     │
│  │  │                                                     │    │     │
│  │  │   Response: {"is_compatible": true}  ✅             │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  │                         │                                   │     │
│  │                         ▼                                   │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │ Step 3: Register Schema (on merge to main)          │    │     │
│  │  │   $ curl -X POST                                    │    │     │
│  │  │     http://schema-registry:8081/subjects/orders-value/versions│
│  │  │     -d @new-schema.json                             │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 압축(Compression)

카프카는 프로듀서 배치 단위로 압축을 적용해 네트워크와 디스크 사용량을 줄인다.

### 압축 동작 원리

```
┌──────────────────────────────────────────────────────────────────────┐
│                    카프카 압축 흐름                                    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [Producer]                                                           │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │  Record Batch (배치)                                        │     │
│  │  ┌──────┬──────┬──────┬──────┬──────┐                      │     │
│  │  │ msg1 │ msg2 │ msg3 │ msg4 │ msg5 │  원본: 1000 bytes    │     │
│  │  └──────┴──────┴──────┴──────┴──────┘                      │     │
│  │                    │                                        │     │
│  │                    │ 압축 (lz4)                             │     │
│  │                    ▼                                        │     │
│  │  ┌────────────────────────┐                                │     │
│  │  │  Compressed Batch      │  압축 후: 400 bytes (60% 감소)  │     │
│  │  └────────────────────────┘                                │     │
│  └─────────────────────────────────────────────────────────────┘     │
│                    │                                                  │
│                    │ 네트워크 전송 (압축된 상태)                        │
│                    ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │  [Broker]                                                   │     │
│  │  ┌────────────────────────┐                                │     │
│  │  │  Compressed Batch      │  그대로 저장 (재압축 없음!)      │     │
│  │  └────────────────────────┘                                │     │
│  └─────────────────────────────────────────────────────────────┘     │
│                    │                                                  │
│                    │ 네트워크 전송 (압축된 상태)                        │
│                    ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────┐     │
│  │  [Consumer]                                                 │     │
│  │  ┌────────────────────────┐                                │     │
│  │  │  Compressed Batch      │                                │     │
│  │  └────────────────────────┘                                │     │
│  │                    │                                        │     │
│  │                    │ 압축 해제                               │     │
│  │                    ▼                                        │     │
│  │  ┌──────┬──────┬──────┬──────┬──────┐                      │     │
│  │  │ msg1 │ msg2 │ msg3 │ msg4 │ msg5 │  원본 복원            │     │
│  │  └──────┴──────┴──────┴──────┴──────┘                      │     │
│  └─────────────────────────────────────────────────────────────┘     │
│                                                                       │
│  💡 핵심: 브로커는 압축/해제 없이 그대로 저장하므로 CPU 부담 없음         │
└──────────────────────────────────────────────────────────────────────┘
```

### 지원 알고리즘 상세 비교

```
┌──────────────────────────────────────────────────────────────────────┐
│                   압축 알고리즘 상세 비교                              │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────┬─────────┬─────────┬─────────┬─────────────────────────┐ │
│  │ 알고리즘 │ 압축률   │ 압축속도 │ 해제속도 │ 특징                     │ │
│  ├─────────┼─────────┼─────────┼─────────┼─────────────────────────┤ │
│  │ none    │ 0%      │ -       │ -       │ 압축 없음                │ │
│  │ gzip    │ ~70%    │ 느림    │ 중간    │ 가장 높은 압축률          │ │
│  │ snappy  │ ~50%    │ 빠름    │ 매우빠름│ Google 개발, 균형잡힘     │ │
│  │ lz4     │ ~55%    │ 매우빠름│ 매우빠름│ 최저 지연, 실시간 추천    │ │
│  │ zstd    │ ~65%    │ 빠름    │ 빠름    │ Facebook, Kafka 2.1+    │ │
│  └─────────┴─────────┴─────────┴─────────┴─────────────────────────┘ │
│                                                                       │
│  [압축 속도 벤치마크 (단위: MB/s)]                                     │
│  ──────────────────────────────────────────────────────────────────── │
│                                                                       │
│  gzip     ████████                           80 MB/s                 │
│  snappy   ████████████████████████████       280 MB/s                │
│  lz4      ████████████████████████████████   400 MB/s                │
│  zstd     ████████████████████               200 MB/s                │
│                                                                       │
│  [압축률 (원본 대비 크기)]                                             │
│  ──────────────────────────────────────────────────────────────────── │
│                                                                       │
│  gzip     ████████               30%  (70% 감소)                     │
│  snappy   ████████████████       50%  (50% 감소)                     │
│  lz4      ██████████████         45%  (55% 감소)                     │
│  zstd     ██████████             35%  (65% 감소)                     │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 선택 가이드

```
┌──────────────────────────────────────────────────────────────────────┐
│                   압축 알고리즘 선택 가이드                            │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  📊 워크로드에 따른 추천                                               │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │                                                              │    │
│  │    지연 민감도                                                │    │
│  │         ▲                                                    │    │
│  │   높음  │  ┌─────────┐                                       │    │
│  │         │  │   lz4   │  ← 실시간 스트리밍, 금융 거래         │    │
│  │         │  └─────────┘                                       │    │
│  │         │       ┌─────────┐                                  │    │
│  │         │       │ snappy  │  ← 범용, 로그 스트리밍           │    │
│  │         │       └─────────┘                                  │    │
│  │         │            ┌─────────┐                             │    │
│  │         │            │  zstd   │  ← 압축률+속도 균형         │    │
│  │         │            └─────────┘                             │    │
│  │   낮음  │                 ┌─────────┐                        │    │
│  │         │                 │  gzip   │  ← 아카이브, 배치 처리 │    │
│  │         │                 └─────────┘                        │    │
│  │         └────────────────────────────────────────────► 압축률│    │
│  │                    낮음                        높음          │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  🎯 사용 사례별 추천                                                   │
│  ┌──────────────────────────┬────────────────────────────────────┐   │
│  │ 사용 사례                 │ 추천 알고리즘                       │   │
│  ├──────────────────────────┼────────────────────────────────────┤   │
│  │ 실시간 이벤트 스트리밍    │ lz4 (최저 지연)                    │   │
│  │ 로그 수집 파이프라인      │ snappy (균형)                      │   │
│  │ IoT 센서 데이터           │ lz4 (고빈도, 저지연)               │   │
│  │ 데이터 아카이브           │ zstd 또는 gzip (저장 비용 절감)    │   │
│  │ 이미 압축된 데이터        │ none (재압축 비효율)               │   │
│  └──────────────────────────┴────────────────────────────────────┘   │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### Producer 압축 설정 예시

```properties
# 기본 압축 설정
compression.type=lz4

# 배치 설정 (압축 효율에 영향)
batch.size=32768          # 32KB - 배치 크기가 클수록 압축률 향상
linger.ms=5               # 5ms 대기 후 전송
```

```java
// Java Producer 설정 예시
Properties props = new Properties();
props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
props.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, "lz4");
props.put(ProducerConfig.BATCH_SIZE_CONFIG, 32768);       // 32KB
props.put(ProducerConfig.LINGER_MS_CONFIG, 5);            // 5ms
props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, 33554432); // 32MB
```

### 브로커 압축 설정

```
┌──────────────────────────────────────────────────────────────────────┐
│                   브로커 compression.type 설정                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [토픽 레벨 설정]                                                      │
│                                                                       │
│  compression.type 값별 동작:                                          │
│                                                                       │
│  ┌─────────────┬─────────────────────────────────────────────────┐   │
│  │ 설정값       │ 동작                                            │   │
│  ├─────────────┼─────────────────────────────────────────────────┤   │
│  │ producer    │ 프로듀서 설정을 그대로 유지 (기본값, 권장)       │   │
│  │ uncompressed│ 브로커가 압축 해제 후 저장 (CPU 사용 ↑)         │   │
│  │ gzip/lz4/.. │ 브로커가 해당 알고리즘으로 재압축 (CPU 사용 ↑)  │   │
│  └─────────────┴─────────────────────────────────────────────────┘   │
│                                                                       │
│  # 토픽 생성 시 압축 강제                                             │
│  kafka-topics.sh --create \                                          │
│    --topic orders \                                                  │
│    --config compression.type=lz4                                     │
│                                                                       │
│  💡 권장: producer 유지하고, 프로듀서에서 압축 통일                    │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Avro + 압축 조합 고려사항

Avro는 binary 포맷이라 기본적으로 JSON보다 더 작은 크기를 제공하며, compression과 함께 사용할 경우 처리량 향상 효과가 크다.

### 직렬화 + 압축 효과 비교

```
┌──────────────────────────────────────────────────────────────────────┐
│                 직렬화 + 압축 조합별 크기 비교                         │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  테스트 데이터: 1000개 주문 메시지                                     │
│                                                                       │
│  [원본 크기 비교]                                                      │
│  ┌────────────────────────────────────────────────────────────┐      │
│  │ JSON (plain)          ████████████████████████████  1000KB │      │
│  │ JSON + gzip           ████████                       300KB │      │
│  │ Avro (plain)          ████████████                   400KB │      │
│  │ Avro + gzip           ████                           150KB │      │
│  │ Avro + lz4            █████                          180KB │      │
│  │ Avro + zstd           ████                           140KB │      │
│  └────────────────────────────────────────────────────────────┘      │
│                                                                       │
│  📊 결과 요약                                                         │
│  ┌──────────────────┬────────┬─────────────────────────────────┐     │
│  │ 조합              │ 크기   │ 원본 대비                        │     │
│  ├──────────────────┼────────┼─────────────────────────────────┤     │
│  │ JSON             │ 1000KB │ 기준                            │     │
│  │ JSON + gzip      │ 300KB  │ 70% 감소                        │     │
│  │ Avro             │ 400KB  │ 60% 감소                        │     │
│  │ Avro + lz4       │ 180KB  │ 82% 감소 (🚀 고속 + 고압축)     │     │
│  │ Avro + zstd      │ 140KB  │ 86% 감소 (🎯 최고 압축)         │     │
│  └──────────────────┴────────┴─────────────────────────────────┘     │
│                                                                       │
│  💡 Avro + 압축 조합이 가장 효율적                                     │
└──────────────────────────────────────────────────────────────────────┘
```

### 배치 크기와 압축 효율 관계

배치 크기를 크게 유지하면 압축 효율이 좋아지지만 지연이 증가하므로, `linger.ms`와 `batch.size`를 workload에 맞춰 조정한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│               배치 크기 vs 압축률 vs 지연 트레이드오프                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [배치 크기별 압축 효율]                                               │
│                                                                       │
│  배치 크기    압축률 (lz4)    End-to-End 지연                         │
│  ─────────────────────────────────────────                            │
│   1KB         ~20%            ~1ms         ← 압축 비효율              │
│   16KB        ~45%            ~3ms                                   │
│   32KB        ~55%            ~5ms         ← 권장 (균형)              │
│   64KB        ~60%            ~10ms                                  │
│   128KB       ~62%            ~20ms        ← 아카이브용               │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────┐      │
│  │  압축률                                                    │      │
│  │    ▲                                                       │      │
│  │ 65%│                               ●────●                  │      │
│  │    │                          ●                            │      │
│  │ 50%│                     ●                                 │      │
│  │    │                ●                                      │      │
│  │ 35%│           ●                                           │      │
│  │    │      ●                                                │      │
│  │ 20%│ ●                                                     │      │
│  │    └────┬────┬────┬────┬────┬────┬────► 배치 크기         │      │
│  │        1K   8K  16K  32K  64K 128K                         │      │
│  │                    ▲                                       │      │
│  │                Sweet Spot                                  │      │
│  └────────────────────────────────────────────────────────────┘      │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 최적 설정 예시

```
┌──────────────────────────────────────────────────────────────────────┐
│               워크로드별 최적 설정                                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [실시간 이벤트 스트리밍]                                              │
│  ───────────────────────                                              │
│  compression.type=lz4                                                │
│  batch.size=16384          # 16KB                                    │
│  linger.ms=1               # 최소 대기                                │
│                                                                       │
│  → 지연 최소화, 압축률 보통                                            │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [로그 수집 파이프라인]                                                │
│  ─────────────────────                                                │
│  compression.type=snappy                                             │
│  batch.size=32768          # 32KB                                    │
│  linger.ms=5               # 5ms 대기                                │
│                                                                       │
│  → 균형 잡힌 설정                                                      │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [데이터 아카이브 / 배치 처리]                                         │
│  ────────────────────────────                                         │
│  compression.type=zstd                                               │
│  batch.size=131072         # 128KB                                   │
│  linger.ms=100             # 100ms 대기                              │
│                                                                       │
│  → 최대 압축률, 저장 비용 절감                                         │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

### 에러 처리 및 DLQ

스키마 등록 실패나 호환성 위반은 프로듀서 전송 자체를 막을 수 있으니, DLQ나 알림과 연계해 빠르게 감지한다.

```
┌──────────────────────────────────────────────────────────────────────┐
│                   스키마 에러 처리 패턴                                │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [에러 시나리오]                                                       │
│                                                                       │
│  1. 스키마 호환성 위반                                                 │
│     Producer → Schema Registry: "Schema not compatible"              │
│                                                                       │
│  2. Schema Registry 연결 실패                                         │
│     Producer → Schema Registry: Connection timeout                   │
│                                                                       │
│  3. 역직렬화 실패                                                      │
│     Consumer: "Unknown schema ID: 999"                               │
│                                                                       │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [DLQ (Dead Letter Queue) 패턴]                                       │
│                                                                       │
│    ┌─────────────┐                                                   │
│    │  Producer   │                                                   │
│    └──────┬──────┘                                                   │
│           │                                                          │
│           ▼                                                          │
│    ┌─────────────┐    성공    ┌─────────────┐                        │
│    │   Kafka     │ ─────────► │  Consumer   │                        │
│    │  (orders)   │            └──────┬──────┘                        │
│    └─────────────┘                   │                               │
│                                      │                               │
│                             ┌───────┴───────┐                        │
│                             │ 역직렬화 실패?  │                        │
│                             └───────┬───────┘                        │
│                                     │                                │
│                          실패       │       성공                      │
│                    ┌────────────────┼────────────────┐               │
│                    ▼                               ▼                │
│             ┌─────────────┐                  처리 완료               │
│             │    DLQ      │                                          │
│             │ (orders.dlq)│                                          │
│             └──────┬──────┘                                          │
│                    │                                                 │
│                    ▼                                                 │
│             ┌─────────────┐                                          │
│             │  알림/모니터링│                                          │
│             │ (PagerDuty) │                                          │
│             └─────────────┘                                          │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

#### Spring Kafka DLQ 설정 예시

```java
@Bean
public ConcurrentKafkaListenerContainerFactory<String, Object> kafkaListenerContainerFactory() {
    ConcurrentKafkaListenerContainerFactory<String, Object> factory = 
        new ConcurrentKafkaListenerContainerFactory<>();
    
    factory.setConsumerFactory(consumerFactory());
    
    // DLQ로 전송하는 에러 핸들러
    factory.setCommonErrorHandler(new DefaultErrorHandler(
        new DeadLetterPublishingRecoverer(kafkaTemplate,
            (record, ex) -> new TopicPartition(record.topic() + ".dlq", record.partition())),
        new FixedBackOff(1000L, 3L)  // 1초 간격, 3회 재시도
    ));
    
    return factory;
}
```

---

## 정리: Avro + 압축 체크리스트

```
┌──────────────────────────────────────────────────────────────────────┐
│                   Avro + 압축 적용 체크리스트                          │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  📋 Schema Registry 설정                                              │
│  □ Schema Registry 클러스터 구성 (HA)                                 │
│  □ 호환성 모드 설정 (BACKWARD 권장)                                    │
│  □ Subject naming 전략 통일                                           │
│  □ CI/CD 파이프라인에 스키마 검증 추가                                 │
│                                                                       │
│  📋 스키마 설계                                                        │
│  □ 필드 추가 시 기본값 지정                                            │
│  □ Optional 필드는 union ["null", "type"] 사용                        │
│  □ 네임스페이스와 doc 주석 작성                                        │
│  □ 버전 관리 전략 수립                                                 │
│                                                                       │
│  📋 압축 설정                                                          │
│  □ 워크로드에 맞는 알고리즘 선택                                       │
│  □ batch.size와 linger.ms 튜닝                                        │
│  □ 압축률/지연 모니터링 설정                                           │
│                                                                       │
│  📋 에러 처리                                                          │
│  □ DLQ 토픽 구성                                                       │
│  □ 스키마 에러 알림 설정                                               │
│  □ 재처리 프로세스 정의                                                │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```
