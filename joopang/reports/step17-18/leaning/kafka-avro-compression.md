# Avro와 압축 전략

## Avro 스키마 관리
- Avro는 스키마와 데이터를 분리해 직렬화하며, Schema Registry에 버전으로 저장해 프로듀서·컨슈머 간 호환성을 유지한다.
- **호환성 모드**: `BACKWARD`(기본)로 설정해 새로운 스키마가 이전 컨슈머와 호환되도록 한다. 필요에 따라 `FULL`, `FORWARD` 모드를 선택한다.
- **스키마 진화 규칙**: 필드 추가 시 기본값을 지정, 필드 삭제 시 optional 처리, 타입 변경 시 union 사용 등 점진적 변화를 준수한다.
- **운영 팁**: 토픽별 subject naming 전략(`<topic>-value`)을 통일하고, CI 단계에서 스키마 검증을 수행한다.

## 압축(Compression)
- 카프카는 프로듀서 배치 단위로 압축을 적용해 네트워크와 디스크 사용량을 줄인다.
- 지원 알고리즘: `gzip`(높은 압축률, 지연 높음), `snappy`(균형), `lz4`(낮은 지연), `zstd`(높은 압축률+낮은 CPU, Kafka 2.1+).
- **선택 가이드**:
  - 지연 민감한 실시간 스트림 → `lz4` 또는 `snappy`.
  - 저장 비용이 큰 이벤트 아카이브 → `gzip` 또는 `zstd`.
  - 이질적 환경 → 토픽별로 compression type을 강제(`compression.type`)하거나 프로듀서 설정으로 통일한다.
- 압축 후에도 브로커는 메시지를 재압축하지 않고 그대로 저장하므로, 컨슈머는 압축을 해제할 수 있어야 한다.

## Avro + 압축 조합 고려사항
- Avro는 binary 포맷이라 기본적으로 JSON보다 더 작은 크기를 제공하며, compression과 함께 사용할 경우 처리량 향상 효과가 크다.
- 배치 크기를 크게 유지하면 압축 효율이 좋아지지만 지연이 증가하므로, `linger.ms`와 `batch.size`를 workload에 맞춰 조정한다.
- 스키마 등록 실패나 호환성 위반은 프로듀서 전송 자체를 막을 수 있으니, DLQ나 알림과 연계해 빠르게 감지한다.
