# AOP (Aspect-Oriented Programming) 정리

## 1. 핵심 개념
- **관심사의 분리**: 핵심 비즈니스 로직(Core Concern)과 부가 기능(Cross-cutting Concern)을 분리하여 모듈화한다.
- **Aspect**: 부가 기능을 의미하며, 여러 조인 포인트에 공통으로 적용된다. 예) 로깅, 트랜잭션, 접근 제어.
- **Join Point**: Aspect가 삽입될 수 있는 지점. Spring AOP에서는 메서드 실행 시점이 기본 대상이다.
- **Advice**: 실제로 실행되는 코드 조각. `@Before`, `@AfterReturning`, `@AfterThrowing`, `@Around` 등으로 구현한다.
- **Pointcut**: 어떤 Join Point에 Aspect를 적용할지 표현식으로 정의한다. 예) `execution(* io.joopang..*Service.*(..))`.
- **Weaving**: 대상 코드에 Aspect를 적용해 프록시 객체를 생성하는 과정. Spring은 런타임 프록시 방식(JDK 동적 프록시, CGLIB)을 사용한다.

## 2. Spring AOP 동작 방식
1. `@Aspect` Bean을 스캔하여 포인트컷과 어드바이스 정보를 읽는다.
2. 매칭되는 대상 Bean에 대해 프록시를 생성한다.
3. 클라이언트가 Bean을 호출하면, 먼저 프록시가 호출을 가로채어 어드바이스 체인을 실행한다.
4. 체인 내부에서 실제 타깃 메서드가 실행되고, 이후 `@After` 계열 어드바이스가 이어진다.

## 3. 장단점
- **장점**
  - 공통 로직을 한 곳에 모아 재사용 및 변경 용이.
  - 핵심 로직이 부가 기능 코드로 오염되지 않음 → 가독성 향상.
- **단점**
  - 프록시 체인과 포인트컷이 복잡할수록 흐름 추적이 어려움.
  - AOP 적용 여부가 런타임에 결정되므로 Self-invocation 같은 예외 케이스가 존재.

## 4. 적용 사례
| 기능 | AOP 적용 이유 |
| --- | --- |
| 트랜잭션 | `@Transactional`이 대표적인 AOP. 메서드 진입/종료 시점에 트랜잭션을 시작·커밋/롤백. |
| 로깅/모니터링 | API 호출 시간을 측정하고 공통 포맷으로 로그 출력. |
| 인증/인가 | 특정 패키지 또는 애노테이션 대상에 접근 권한 체크 삽입. |
| 멱등 토큰 검증 | 컨트롤러 진입 전에 헤더·파라미터를 검사해 Reject. |

## 5. 설계 시 체크리스트
1. **포인트컷 범위**: 너무 넓으면 의도치 않은 메서드에도 적용된다. 최소한의 범위를 명시.
2. **순서 보장**: 여러 Aspect가 겹치면 `@Order` 또는 `Ordered`를 구현해 실행 순서 명시.
3. **예외 처리**: `@AfterThrowing` 또는 `try/catch`로 예외 흐름을 명확히 정의.
4. **프록시 타입**: 인터페이스 기반이면 JDK 프록시, 그렇지 않으면 CGLIB. 프록시 타입에 따라 `this` 캐스팅 가능 여부가 달라진다.
5. **테스트 전략**: 슬라이스 테스트나 통합 테스트에서 AOP가 실제로 적용되는지 검증한다.
